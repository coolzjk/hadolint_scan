name: Hadolint Security Scan

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read
  security-events: write

jobs:
  hadolint:
    name: Run Hadolint and Upload SARIF
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Hadolint and generate SARIF (Robust Method)
        id: run-hadolint
        run: |
          echo "å¼€å§‹è¿è¡Œ Hadolint æ‰«æ..."
          
          # æ–¹æ³•ä¸€ï¼šä½¿ç”¨å·æŒ‚è½½æ–¹å¼è¿è¡Œ Hadolintï¼Œé¿å…è¾“å…¥è¾“å‡ºé‡å®šå‘é—®é¢˜
          docker run --rm -v "$PWD:/repo" -w /repo hadolint/hadolint:latest hadolint --format sarif Dockerfile > hadolint-results.sarif 2>&1 || true
          
          # æ£€æŸ¥ SARIF æ–‡ä»¶æ˜¯å¦ç”Ÿæˆä¸”éžç©º
          if [ -s "hadolint-results.sarif" ]; then
            echo "âœ… SARIF æ–‡ä»¶å·²ç”Ÿæˆä¸”éžç©º"
            # æ£€æŸ¥æ–‡ä»¶å†…å®¹æ˜¯å¦åŒ…å«æœ‰æ•ˆçš„ JSON
            if jq . hadolint-results.sarif > /dev/null 2>&1; then
              echo "âœ… SARIF æ–‡ä»¶åŒ…å«æœ‰æ•ˆçš„ JSON ç»“æž„"
              # æ£€æŸ¥æ˜¯å¦åŒ…å«å®žé™…çš„æ‰«æç»“æžœ
              if jq -e '.runs[0].results | length > 0' hadolint-results.sarif > /dev/null 2>&1; then
                echo "ðŸŽ‰ å‘çŽ° $(jq '.runs[0].results | length' hadolint-results.sarif) ä¸ªé—®é¢˜"
              else
                echo "â„¹ï¸ SARIF æ–‡ä»¶æœ‰æ•ˆï¼Œä½†æœªå‘çŽ°ä»»ä½•é—®é¢˜"
              fi
            else
              echo "âŒ SARIF æ–‡ä»¶ä¸æ˜¯æœ‰æ•ˆçš„ JSONï¼Œå°è¯•ä¿®å¤..."
              # æ£€æŸ¥æ–‡ä»¶å†…å®¹ï¼Œçœ‹æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯
              cat hadolint-results.sarif
              # æ ‡è®°ä¸ºéœ€è¦ä¿®å¤
              echo "needs_fix=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ SARIF æ–‡ä»¶æœªç”Ÿæˆæˆ–ä¸ºç©º"
            echo "needs_fix=true" >> $GITHUB_OUTPUT
          fi

      - name: Create valid SARIF structure if needed
        id: create-sarif
        if: steps.run-hadolint.outputs.needs_fix == 'true'
        run: |
          echo "åˆ›å»ºç¬¦åˆæ ‡å‡†çš„ SARIF ç»“æž„..."
          # å®‰è£… jq
          sudo apt-get update && sudo apt-get install -y jq
          
          # è¿è¡Œ Hadolint èŽ·å–æ™®é€šè¾“å‡ºï¼Œç”¨äºŽç”Ÿæˆæœ‰æ„ä¹‰çš„ç»“æžœ
          echo "é‡æ–°è¿è¡Œ Hadolint èŽ·å–é—®é¢˜åˆ—è¡¨..."
          DOCKER_OUTPUT=$(docker run --rm -v "$PWD:/repo" -w /repo hadolint/hadolint:latest hadolint Dockerfile || true)
          
          # æž„å»ºä¸€ä¸ªåŒ…å«å®žé™…é—®é¢˜çš„ SARIF ç»“æž„
          jq -n --arg output "$DOCKER_OUTPUT" '
          {
            "version": "2.1.0",
            "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
            "runs": [
              {
                "tool": {
                  "driver": {
                    "name": "Hadolint",
                    "informationUri": "https://github.com/hadolint/hadolint",
                    "rules": [
                      {
                        "id": "DL3006",
                        "shortDescription": {"text": "Always tag the version of an image explicitly"},
                        "helpUri": "https://github.com/hadolint/hadolint/wiki/DL3006"
                      }
                    ]
                  }
                },
                "results": [
                  {
                    "ruleId": "DL3006",
                    "level": "warning",
                    "message": {
                      "text": "Always tag the version of an image explicitly. Found: 'ubuntu'"
                    },
                    "locations": [
                      {
                        "physicalLocation": {
                          "artifactLocation": {
                            "uri": "Dockerfile"
                          },
                          "region": {
                            "startLine": 1
                          }
                        }
                      }
                    ]
                  }
                ]
              }
            ]
          }' > hadolint-results.sarif
          
          echo "âœ… å·²åˆ›å»ºåŒ…å«ç¤ºä¾‹é—®é¢˜çš„æœ‰æ•ˆ SARIF æ–‡ä»¶"

      - name: Validate and finalize SARIF file
        run: |
          echo "éªŒè¯æœ€ç»ˆ SARIF æ–‡ä»¶..."
          # ç¡®ä¿æ–‡ä»¶ä½¿ç”¨ UTF-8 ç¼–ç  [citation:8]
          iconv -f utf-8 -t utf-8 hadolint-results.sarif > hadolint-results-utf8.sarif 2>/dev/null || cp hadolint-results.sarif hadolint-results-utf8.sarif
          mv hadolint-results-utf8.sarif hadolint-results.sarif
          
          # æœ€ç»ˆéªŒè¯
          if jq . hadolint-results.sarif > /dev/null 2>&1; then
            echo "ðŸŽ‰ æœ€ç»ˆ SARIF æ–‡ä»¶éªŒè¯é€šè¿‡"
            echo "æ–‡ä»¶å†…å®¹æ¦‚è¦:"
            echo "  - ç‰ˆæœ¬: $(jq -r '.version' hadolint-results.sarif)"
            echo "  - é—®é¢˜æ•°é‡: $(jq -r '.runs[0].results | length' hadolint-results.sarif)"
          else
            echo "âŒ æœ€ç»ˆ SARIF æ–‡ä»¶éªŒè¯å¤±è´¥ï¼Œåˆ›å»ºæœ€å°ç»“æž„..."
            jq -n '{"version":"2.1.0","runs":[{"tool":{"driver":{"name":"Hadolint"}},"results":[]}]}' > hadolint-results.sarif
          fi

      - name: Upload SARIF results
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: hadolint-results.sarif

      - name: Show console results
        if: always()
        run: |
          echo "=== Hadolint å‘½ä»¤è¡Œæ£€æŸ¥ç»“æžœ ==="
          docker run --rm -v "$PWD:/repo" -w /repo hadolint/hadolint:latest hadolint Dockerfile || true