name: Hadolint Security Scan

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read
  security-events: write

jobs:
  hadolint:
    name: Run Hadolint and Upload SARIF
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Run Hadolint and generate SARIF
        id: run-hadolint
        run: |
          echo "å¼€å§‹è¿è¡Œ Hadolint æ‰«æ..."
          
          # æ–¹æ³•ä¸€ï¼šç›´æ¥ä½¿ç”¨æ ‡å‡†è¾“å…¥è¾“å‡ºï¼Œé¿å…æƒé™é—®é¢˜
          docker run --rm -i hadolint/hadolint:latest --format sarif < Dockerfile > hadolint-raw.sarif 2>/dev/null || true
          
          # æ£€æŸ¥åŸå§‹æ–‡ä»¶
          if [ -s "hadolint-raw.sarif" ]; then
            echo "âœ… åŸå§‹ SARIF æ–‡ä»¶å·²ç”Ÿæˆ"
            if jq . hadolint-raw.sarif > /dev/null 2>&1; then
              echo "âœ… åŸå§‹ SARIF æ–‡ä»¶æ˜¯æœ‰æ•ˆçš„ JSON"
              cp hadolint-raw.sarif hadolint-results.sarif
              ISSUE_COUNT=$(jq -r '.runs[0].results | length' hadolint-raw.sarif)
              echo "ğŸ‰ å‘ç° $ISSUE_COUNT ä¸ªé—®é¢˜ï¼Œç›´æ¥ä½¿ç”¨åŸå§‹æ–‡ä»¶"
              echo "use_raw=true" >> $GITHUB_OUTPUT
            else
              echo "âŒ åŸå§‹ SARIF æ–‡ä»¶ä¸æ˜¯æœ‰æ•ˆçš„ JSON"
              echo "use_raw=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ åŸå§‹ SARIF æ–‡ä»¶æœªç”Ÿæˆæˆ–ä¸ºç©º"
            echo "use_raw=false" >> $GITHUB_OUTPUT
          fi

      - name: Create enhanced SARIF if needed
        id: create-sarif
        if: steps.run-hadolint.outputs.use_raw != 'true'
        run: |
          echo "åˆ›å»ºå¢å¼ºç‰ˆ SARIF æ–‡ä»¶..."
          
          # è·å–æ‰€æœ‰é—®é¢˜çš„æ§åˆ¶å°è¾“å‡º
          echo "è·å–è¯¦ç»†é—®é¢˜åˆ—è¡¨..."
          DOCKER_OUTPUT=$(docker run --rm -i hadolint/hadolint:latest < Dockerfile 2>/dev/null || true)
          
          # è§£ææ§åˆ¶å°è¾“å‡ºï¼Œæ„å»ºå®Œæ•´çš„é—®é¢˜åˆ—è¡¨
          RULES=()
          RESULTS=()
          
          # è§£ææ¯ä¸€è¡Œè¾“å‡ºï¼Œæå–è§„åˆ™IDå’Œé—®é¢˜ä¿¡æ¯
          while IFS= read -r line; do
            if [[ $line =~ DL[0-9]+\|(error|warning|info|style)\|(DL[0-9]+):(.+) ]]; then
              LEVEL="${BASH_REMATCH[1]}"
              RULE_ID="${BASH_REMATCH[2]}"
              MESSAGE="${BASH_REMATCH[3]}"
              
              # æ·»åŠ è§„åˆ™åˆ°è§„åˆ™åˆ—è¡¨ï¼ˆå»é‡ï¼‰
              if [[ ! " ${RULES[@]} " =~ " ${RULE_ID} " ]]; then
                RULES+=("$RULE_ID")
              fi
              
              # ç®€å•çš„è¡Œå·æ¨æ–­ï¼ˆåŸºäºé—®é¢˜é¡ºåºï¼‰
              LINE_NUMBER=$(( ${#RESULTS[@]} + 1 ))
              
              # æ„å»ºç»“æœå¯¹è±¡
              RESULTS+=("
                {
                  \"ruleId\": \"$RULE_ID\",
                  \"level\": \"$LEVEL\",
                  \"message\": {
                    \"text\": \"$MESSAGE\"
                  },
                  \"locations\": [
                    {
                      \"physicalLocation\": {
                        \"artifactLocation\": {
                          \"uri\": \"Dockerfile\"
                        },
                        \"region\": {
                          \"startLine\": $LINE_NUMBER
                        }
                      }
                    }
                  ]
                }
              ")
            fi
          done <<< "$DOCKER_OUTPUT"
          
          # æ„å»ºè§„åˆ™æ•°ç»„JSON
          RULES_JSON=""
          for rule in "${RULES[@]}"; do
            if [ -n "$RULES_JSON" ]; then
              RULES_JSON+=","
            fi
            RULES_JSON+="
            {
              \"id\": \"$rule\",
              \"shortDescription\": {
                \"text\": \"$rule rule\"
              },
              \"helpUri\": \"https://github.com/hadolint/hadolint/wiki/$rule\"
            }"
          done
          
          # æ„å»ºç»“æœæ•°ç»„JSON
          RESULTS_JSON=""
          for result in "${RESULTS[@]}"; do
            if [ -n "$RESULTS_JSON" ]; then
              RESULTS_JSON+=","
            fi
            RESULTS_JSON+="$result"
          done
          
          # åˆ›å»ºå®Œæ•´çš„SARIFç»“æ„
          jq -n \
            --argjson rules "[$RULES_JSON]" \
            --argjson results "[$RESULTS_JSON]" \
            '{
              "version": "2.1.0",
              "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
              "runs": [
                {
                  "tool": {
                    "driver": {
                      "name": "Hadolint",
                      "informationUri": "https://github.com/hadolint/hadolint",
                      "rules": $rules
                    }
                  },
                  "results": $results
                }
              ]
            }' > hadolint-results.sarif
          
          FINAL_COUNT=$(jq -r '.runs[0].results | length' hadolint-results.sarif)
          echo "âœ… å¢å¼ºç‰ˆ SARIF æ–‡ä»¶å·²åˆ›å»ºï¼ŒåŒ…å« $FINAL_COUNT ä¸ªé—®é¢˜"

      - name: Use raw SARIF if available
        if: steps.run-hadolint.outputs.use_raw == 'true'
        run: |
          echo "ä½¿ç”¨åŸå§‹ SARIF æ–‡ä»¶"
          cp hadolint-raw.sarif hadolint-results.sarif

      - name: Validate final SARIF file
        run: |
          echo "=== æœ€ç»ˆ SARIF æ–‡ä»¶éªŒè¯ ==="
          if jq . hadolint-results.sarif > /dev/null 2>&1; then
            echo "âœ… æœ€ç»ˆ SARIF æ–‡ä»¶éªŒè¯é€šè¿‡"
            echo "æ–‡ä»¶å†…å®¹æ¦‚è¦:"
            echo "  - ç‰ˆæœ¬: $(jq -r '.version' hadolint-results.sarif)"
            echo "  - å·¥å…·: $(jq -r '.runs[0].tool.driver.name' hadolint-results.sarif)"
            echo "  - è§„åˆ™æ•°é‡: $(jq -r '.runs[0].tool.driver.rules | length' hadolint-results.sarif)"
            echo "  - é—®é¢˜æ€»æ•°: $(jq -r '.runs[0].results | length' hadolint-results.sarif)"
            
            # æ˜¾ç¤ºå…·ä½“é—®é¢˜ç»Ÿè®¡
            echo "é—®é¢˜çº§åˆ«ç»Ÿè®¡:"
            jq -r '.runs[0].results[].level' hadolint-results.sarif | sort | uniq -c | while read count level; do
              echo "  - $level: $count ä¸ª"
            done || true
          else
            echo "âŒ æœ€ç»ˆ SARIF æ–‡ä»¶éªŒè¯å¤±è´¥"
            exit 1
          fi

      - name: Upload SARIF results
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: hadolint-results.sarif

      - name: Show console results
        if: always()
        run: |
          echo "=== Hadolint å‘½ä»¤è¡Œæ£€æŸ¥ç»“æœ ==="
          docker run --rm -i hadolint/hadolint:latest < Dockerfile || true
          echo "=============================="