name: Hadolint Security Scan

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read
  security-events: write  # å¿…é¡»æ‹¥æœ‰å†™å…¥å®‰å…¨äº‹ä»¶çš„æƒé™[citation:9]

jobs:
  hadolint:
    name: Run Hadolint and Upload SARIF
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Hadolint and generate SARIF
        id: run-hadolint
        run: |
          echo "å¼€å§‹è¿è¡Œ Hadolint æ‰«æ..."
          # ä½¿ç”¨Dockerè¿è¡ŒHadolintï¼Œæ˜ç¡®æŒ‡å®šSARIFæ ¼å¼è¾“å‡ºåˆ°æ–‡ä»¶[citation:9]
          docker run --rm -v "$PWD/Dockerfile:/Dockerfile" hadolint/hadolint:latest \
            /bin/bash -c "hadolint --format sarif /Dockerfile > /output.sarif" || true
          
          # å°†å®¹å™¨å†…çš„è¾“å‡ºæ–‡ä»¶å¤åˆ¶åˆ°å·¥ä½œæµå·¥ä½œåŒº
          docker create --name temp-container hadolint/hadolint:latest
          docker cp temp-container:/output.sarif ./hadolint-results.sarif || true
          docker rm temp-container

          # æ£€æŸ¥SARIFæ–‡ä»¶æ˜¯å¦å·²ç”Ÿæˆ
          if [ -f "hadolint-results.sarif" ]; then
            echo "âœ… SARIF æ–‡ä»¶å·²ç”Ÿæˆ"
            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºç©º
            if [ -s "hadolint-results.sarif" ]; then
              echo "âœ… SARIF æ–‡ä»¶éç©º"
            else
              echo "âš ï¸ SARIF æ–‡ä»¶ä¸ºç©ºï¼Œå°†åˆ›å»ºæœ‰æ•ˆç»“æ„"
            fi
          else
            echo "âŒ SARIF æ–‡ä»¶æœªç”Ÿæˆï¼Œå°†åˆ›å»ºæœ‰æ•ˆç»“æ„"
          fi

      - name: Ensure valid SARIF structure
        id: ensure-sarif
        run: |
          echo "ç¡®ä¿ SARIF æ–‡ä»¶ç»“æ„æœ‰æ•ˆ..."
          
          # å®‰è£… jq ç”¨äº JSON å¤„ç†
          sudo apt-get update && sudo apt-get install -y jq
          
          # æ£€æŸ¥ç°æœ‰æ–‡ä»¶æ˜¯å¦ä¸ºæœ‰æ•ˆçš„JSON
          if [ -f "hadolint-results.sarif" ] && jq . hadolint-results.sarif > /dev/null 2>&1; then
            echo "âœ… ç°æœ‰ SARIF æ–‡ä»¶åŒ…å«æœ‰æ•ˆçš„ JSON"
            # ç¡®ä¿æ–‡ä»¶ä½¿ç”¨ UTF-8 ç¼–ç [citation:5]
            iconv -f utf-8 -t utf-8 hadolint-results.sarif > hadolint-results-utf8.sarif 2>/dev/null || cp hadolint-results.sarif hadolint-results-utf8.sarif
            mv hadolint-results-utf8.sarif hadolint-results.sarif
          else
            echo "ğŸ”„ åˆ›å»ºç¬¦åˆæ ‡å‡†çš„æœ€å° SARIF ç»“æ„..."
            # åˆ›å»ºä¸€ä¸ªå®Œå…¨ç¬¦åˆ SARIF æ ‡å‡†çš„æœ€å°æœ‰æ•ˆç»“æ„[citation:8]
            jq -n \
              '{
                "version": "2.1.0",
                "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
                "runs": [
                  {
                    "tool": {
                      "driver": {
                        "name": "Hadolint",
                        "informationUri": "https://github.com/hadolint/hadolint",
                        "rules": []
                      }
                    },
                    "results": []
                  }
                ]
              }' > hadolint-results.sarif
          fi
          
          # éªŒè¯æœ€ç»ˆæ–‡ä»¶
          echo "æœ€ç»ˆ SARIF æ–‡ä»¶å†…å®¹:"
          cat hadolint-results.sarif

      - name: Upload SARIF results
        uses: github/codeql-action/upload-sarif@v4  # ä½¿ç”¨æœ€æ–°çš„v4ç‰ˆæœ¬[citation:6]
        with:
          sarif_file: hadolint-results.sarif

      - name: Show console results
        if: always()
        run: |
          echo "=== Hadolint å‘½ä»¤è¡Œæ£€æŸ¥ç»“æœ ==="
          # åœ¨æ§åˆ¶å°è¾“å‡ºä¼ ç»Ÿæ£€æŸ¥ç»“æœï¼Œä¾¿äºç›´æ¥æŸ¥çœ‹
          docker run --rm -i hadolint/hadolint < Dockerfile || true