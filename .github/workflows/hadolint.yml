name: Hadolint Security Scan

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

# 完整的权限配置
permissions:
  contents: read
  security-events: write
  actions: read
  checks: write

jobs:
  hadolint:
    name: Run Hadolint Dockerfile Linter
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run Hadolint with SARIF output
      id: hadolint
      uses: hadolint/hadolint-action@v3.1.0
      with:
        dockerfile: Dockerfile
        format: sarif
        output-file: hadolint-results.sarif
        no-fail: false
        
    - name: Validate SARIF file
      run: |
        if [ -f hadolint-results.sarif ]; then
          echo "Validating SARIF file..."
          jq . hadolint-results.sarif > /dev/null && echo "✅ SARIF file is valid JSON"
        else
          echo "❌ SARIF file not found"
        fi
        
      continue-on-error: true

    - name: Validate SARIF file content
      run: |
        echo "=== SARIF File Content ==="
        cat hadolint-results.sarif
        echo "=========================="
        
        # 确保文件存在且有效
        if [ ! -f hadolint-results.sarif ]; then
          echo "Creating fallback SARIF file"
          echo '{"version": "2.1.0", "runs": [{"tool": {"driver": {"name": "Hadolint"}}, "results": []}]}' > hadolint-results.sarif
        fi

    - name: Upload SARIF results
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: hadolint-results.sarif
      env:
        # 确保使用正确的 token
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Show detailed console output
      if: always()
      run: |
        echo "=== Detailed Hadolint Output ==="
        docker run --rm -i hadolint/hadolint < Dockerfile || true