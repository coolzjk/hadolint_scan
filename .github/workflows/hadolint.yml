name: Hadolint Security Scan

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read
  security-events: write

jobs:
  hadolint:
    name: Run Hadolint and Upload SARIF
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Run Hadolint and generate SARIF
        id: run-hadolint
        run: |
          echo "å¼€å§‹è¿è¡Œ Hadolint æ‰«æ..."
          
          # æ–¹æ³•ä¸€ï¼šä½¿ç”¨å·æŒ‚è½½æ–¹å¼è¿è¡Œ Hadolint
          docker run --rm -v "$PWD:/repo" -w /repo hadolint/hadolint:latest hadolint --format sarif Dockerfile > hadolint-results.sarif 2>&1 || true
          
          # æ£€æŸ¥ SARIF æ–‡ä»¶æ˜¯å¦ç”Ÿæˆä¸”éžç©º
          if [ -s "hadolint-results.sarif" ]; then
            echo "âœ… SARIF æ–‡ä»¶å·²ç”Ÿæˆä¸”éžç©º"
            # æ£€æŸ¥æ–‡ä»¶å†…å®¹æ˜¯å¦åŒ…å«æœ‰æ•ˆçš„ JSON
            if jq . hadolint-results.sarif > /dev/null 2>&1; then
              echo "âœ… SARIF æ–‡ä»¶åŒ…å«æœ‰æ•ˆçš„ JSON ç»“æž„"
              # æ£€æŸ¥æ˜¯å¦åŒ…å«å®žé™…çš„æ‰«æç»“æžœ
              if jq -e '.runs[0].results | length > 0' hadolint-results.sarif > /dev/null 2>&1; then
                ISSUE_COUNT=$(jq '.runs[0].results | length' hadolint-results.sarif)
                echo "ðŸŽ‰ å‘çŽ° $ISSUE_COUNT ä¸ªé—®é¢˜"
                echo "needs_fix=false" >> $GITHUB_OUTPUT
              else
                echo "â„¹ï¸ SARIF æ–‡ä»¶æœ‰æ•ˆï¼Œä½†æœªå‘çŽ°ä»»ä½•é—®é¢˜"
                echo "needs_fix=true" >> $GITHUB_OUTPUT
              fi
            else
              echo "âŒ SARIF æ–‡ä»¶ä¸æ˜¯æœ‰æ•ˆçš„ JSON"
              echo "needs_fix=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ SARIF æ–‡ä»¶æœªç”Ÿæˆæˆ–ä¸ºç©º"
            echo "needs_fix=true" >> $GITHUB_OUTPUT
          fi

      - name: Get all issues from console output
        id: get-issues
        if: steps.run-hadolint.outputs.needs_fix == 'true'
        run: |
          echo "ä»ŽæŽ§åˆ¶å°è¾“å‡ºèŽ·å–æ‰€æœ‰é—®é¢˜..."
          # è¿è¡Œ Hadolint èŽ·å–è¯¦ç»†çš„æŽ§åˆ¶å°è¾“å‡º
          DOCKER_OUTPUT=$(docker run --rm -v "$PWD:/repo" -w /repo hadolint/hadolint:latest hadolint --no-color Dockerfile 2>&1 || true)
          
          echo "åŽŸå§‹æŽ§åˆ¶å°è¾“å‡º:"
          echo "$DOCKER_OUTPUT"
          
          # ä¿å­˜æŽ§åˆ¶å°è¾“å‡ºåˆ°æ–‡ä»¶ï¼Œä¾›åŽç»­æ­¥éª¤ä½¿ç”¨
          echo "$DOCKER_OUTPUT" > hadolint-console.txt
          
          # è§£æžé—®é¢˜æ•°é‡
          ISSUE_COUNT=$(echo "$DOCKER_OUTPUT" | grep -c "DL[0-9]\+" || true)
          echo "å‘çŽ° $ISSUE_COUNT ä¸ªé—®é¢˜"
          echo "issue_count=$ISSUE_COUNT" >> $GITHUB_OUTPUT

      - name: Create complete SARIF with all issues
        id: create-sarif
        if: steps.run-hadolint.outputs.needs_fix == 'true'
        run: |
          echo "åˆ›å»ºåŒ…å«æ‰€æœ‰é—®é¢˜çš„å®Œæ•´ SARIF ç»“æž„..."
          
          # è¯»å–æŽ§åˆ¶å°è¾“å‡º
          CONSOLE_OUTPUT=$(cat hadolint-console.txt)
          
          # åˆå§‹åŒ– SARIF ç»“æž„
          SARIF_TEMPLATE='{
            "version": "2.1.0",
            "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
            "runs": [
              {
                "tool": {
                  "driver": {
                    "name": "Hadolint",
                    "informationUri": "https://github.com/hadolint/hadolint",
                    "rules": []
                  }
                },
                "results": []
              }
            ]
          }'
          
          echo "$SARIF_TEMPLATE" | jq . > hadolint-results.sarif
          
          # è§£æžæ¯ä¸€è¡Œè¾“å‡ºï¼Œæå–é—®é¢˜ä¿¡æ¯
          LINE_NUMBER=0
          echo "$CONSOLE_OUTPUT" | while IFS= read -r line; do
            LINE_NUMBER=$((LINE_NUMBER + 1))
            
            # åŒ¹é… Hadolint é—®é¢˜æ ¼å¼: DL3006 Always tag the version of an image explicitly
            if [[ "$line" =~ (DL[0-9]+)[[:space:]]+(.*) ]]; then
              RULE_ID="${BASH_REMATCH[1]}"
              MESSAGE="${BASH_REMATCH[2]}"
              
              # ç¡®å®šé—®é¢˜çº§åˆ«
              LEVEL="warning"
              if [[ "$MESSAGE" == *"error"* ]]; then
                LEVEL="error"
              elif [[ "$MESSAGE" == *"info"* ]]; then
                LEVEL="note"
              elif [[ "$MESSAGE" == *"style"* ]]; then
                LEVEL="note"
              fi
              
              echo "å¤„ç†é—®é¢˜: $RULE_ID - $MESSAGE (çº§åˆ«: $LEVEL)"
              
              # æ·»åŠ è§„åˆ™åˆ°è§„åˆ™åˆ—è¡¨ï¼ˆå¦‚æžœä¸å­˜åœ¨ï¼‰
              CURRENT_RULES=$(jq '.runs[0].tool.driver.rules' hadolint-results.sarif)
              RULE_EXISTS=$(echo "$CURRENT_RULES" | jq --arg rule "$RULE_ID" 'any(.[]; .id == $rule)')
              
              if [ "$RULE_EXISTS" = "false" ]; then
                jq --arg rule "$RULE_ID" \
                  '.runs[0].tool.driver.rules += [{
                    "id": $rule,
                    "shortDescription": {"text": $rule},
                    "helpUri": "https://github.com/hadolint/hadolint/wiki/\($rule)"
                  }]' hadolint-results.sarif > temp.sarif && mv temp.sarif hadolint-results.sarif
              fi
              
              # æ·»åŠ é—®é¢˜åˆ°ç»“æžœåˆ—è¡¨
              # ç®€å•æ˜ å°„ï¼šç¬¬ä¸€ä¸ªé—®é¢˜åœ¨ç¬¬1è¡Œï¼Œç¬¬äºŒä¸ªåœ¨ç¬¬3è¡Œï¼Œä»¥æ­¤ç±»æŽ¨ï¼ˆè¿™æ˜¯è¿‘ä¼¼æ˜ å°„ï¼‰
              APPROX_LINE=$((LINE_NUMBER * 2 - 1))
              
              jq --arg rule "$RULE_ID" --arg level "$LEVEL" --arg message "$MESSAGE" --argjson line "$APPROX_LINE" \
                '.runs[0].results += [{
                  "ruleId": $rule,
                  "level": $level,
                  "message": {"text": $message},
                  "locations": [
                    {
                      "physicalLocation": {
                        "artifactLocation": {"uri": "Dockerfile"},
                        "region": {"startLine": $line}
                      }
                    }
                  ]
                }]' hadolint-results.sarif > temp.sarif && mv temp.sarif hadolint-results.sarif
            fi
          done
          
          FINAL_COUNT=$(jq '.runs[0].results | length' hadolint-results.sarif)
          echo "âœ… å·²åˆ›å»ºåŒ…å« $FINAL_COUNT ä¸ªé—®é¢˜çš„å®Œæ•´ SARIF æ–‡ä»¶"

      - name: Validate final SARIF file
        run: |
          echo "éªŒè¯æœ€ç»ˆ SARIF æ–‡ä»¶..."
          
          # æœ€ç»ˆéªŒè¯
          if jq . hadolint-results.sarif > /dev/null 2>&1; then
            echo "ðŸŽ‰ æœ€ç»ˆ SARIF æ–‡ä»¶éªŒè¯é€šè¿‡"
            echo "æ–‡ä»¶å†…å®¹æ¦‚è¦:"
            echo "  - ç‰ˆæœ¬: $(jq -r '.version' hadolint-results.sarif)"
            RULE_COUNT=$(jq -r '.runs[0].tool.driver.rules | length' hadolint-results.sarif)
            ISSUE_COUNT=$(jq -r '.runs[0].results | length' hadolint-results.sarif)
            echo "  - è§„åˆ™æ•°é‡: $RULE_COUNT"
            echo "  - é—®é¢˜æ•°é‡: $ISSUE_COUNT"
            
            # æ˜¾ç¤ºå…·ä½“é—®é¢˜åˆ—è¡¨
            echo "æ£€æµ‹åˆ°çš„é—®é¢˜:"
            jq -r '.runs[0].results[] | "  - \(.ruleId): \(.message.text)"' hadolint-results.sarif
          else
            echo "âŒ æœ€ç»ˆ SARIF æ–‡ä»¶éªŒè¯å¤±è´¥ï¼Œåˆ›å»ºæœ€å°ç»“æž„..."
            jq -n '{"version":"2.1.0","runs":[{"tool":{"driver":{"name":"Hadolint"}},"results":[]}]}' > hadolint-results.sarif
          fi

      - name: Upload SARIF results
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: hadolint-results.sarif

      - name: Show console results
        if: always()
        run: |
          echo "=== Hadolint å‘½ä»¤è¡Œæ£€æŸ¥ç»“æžœ ==="
          docker run --rm -v "$PWD:/repo" -w /repo hadolint/hadolint:latest hadolint --no-color Dockerfile || true