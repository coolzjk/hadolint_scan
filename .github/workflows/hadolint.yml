name: Hadolint Security Scan

on:
  push:
    branches: [ main, master ]
  pull_request:
    types: [opened, synchronize, reopened]  # 明确指定 PR 事件类型
    branches: [ main, master ]

# 关键设置：为 GITHUB_TOKEN 显式定义权限
permissions:
  contents: read
  security-events: write  # 必须拥有写入安全事件的权限

jobs:
  hadolint:
    name: Run Hadolint and Upload Report
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        # 安全最佳实践：对于 PR，检出特定提交而非合并提交
        ref: ${{ github.event.pull_request.head.sha || github.sha }}

    - name: Run Hadolint
      id: lint
      continue-on-error: true  # 即使发现错误，也让工作流继续，以便上传报告
      uses: hadolint/hadolint-action@v3.1.0
      with:
        dockerfile: Dockerfile
        format: sarif
        output-file: hadolint-results.sarif

    - name: Upload SARIF results to Code Scanning
      # 仅在 SARIF 文件生成后上传
      if: always() && steps.lint.outcome == 'success' && hashFiles('hadolint-results.sarif') == 1
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: hadolint-results.sarif